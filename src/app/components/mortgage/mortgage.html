<div class="card">
  <h2>Finanzierung</h2>

  <div class="form-row form-row--two">
    <div class="form-group">
      <label for="equity">Eigenkapital (€)</label>
      <input
        id="equity"
        type="text"
        inputmode="numeric"
        [value]="equityDisplay"
        (input)="onEquityAbsoluteInput($event)"
        (focus)="onEquityAbsoluteFocus()"
        (blur)="onEquityAbsoluteBlur()"
        placeholder="z.B. 80.000"
      />
    </div>
    <div class="form-group">
      <label for="equityPercent">Eigenkapital (%)</label>
      <input
        id="equityPercent"
        type="number"
        step="0.1"
        min="0"
        max="100"
        [value]="equityPercentDisplay"
        (input)="onEquityPercentInput($event)"
      />
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <label for="interestRate">Sollzins (%)</label>
      <input
        id="interestRate"
        type="number"
        step="0.1"
        min="0"
        [value]="interestRate()"
        (change)="onNumberChange('interest', $event)"
      />
    </div>
    <div class="form-group">
      <label for="repaymentRate">Tilgung (%)</label>
      <input
        id="repaymentRate"
        type="number"
        step="0.1"
        min="0"
        [value]="repaymentRate()"
        (change)="onNumberChange('repayment', $event)"
      />
    </div>
    <div class="form-group">
      <label for="fixedPeriod">Zinsbindung (Jahre)</label>
      <input
        id="fixedPeriod"
        type="number"
        step="1"
        min="1"
        max="30"
        [value]="fixedPeriodYears()"
        (change)="onNumberChange('years', $event)"
      />
    </div>
  </div>

  <div class="form-row form-row--two">
    <div class="form-group">
      <label for="specialRepaymentRate">Sondertilgung (% p.a.)</label>
      <input
        id="specialRepaymentRate"
        type="number"
        step="1"
        min="0"
        max="100"
        [value]="specialRepaymentRate()"
        (input)="onSpecialRepaymentPercentChange($event)"
      />
    </div>
    <div class="form-group">
      <label for="specialRepaymentSurcharge">Zinsaufschlag Sondertilgung (Pp.)</label>
      <input
        id="specialRepaymentSurcharge"
        type="number"
        step="0.05"
        min="0"
        [value]="specialRepaymentSurcharge()"
        (change)="onNumberChange('specialSurcharge', $event)"
      />
    </div>
  </div>

  @if (specialRepaymentSurcharge() > 0) {
    <div class="effective-rate">
      Effektiver Sollzins: {{ interestRate() | number:'1.2-2':'de-DE' }} % + {{ specialRepaymentSurcharge() | number:'1.2-2':'de-DE' }} Pp. = <strong>{{ effectiveInterestRate | number:'1.2-2':'de-DE' }} %</strong>
    </div>
  }

  @if (lowEquityWarning) {
    <div class="warning">
      Ihr Eigenkapital liegt unter 20 % der Gesamtkosten. Banken verlangen in der Regel mindestens 10–20 % Eigenkapitalanteil.
    </div>
  }

  <div class="loan-info">
    <span class="label">Darlehensbetrag</span>
    <span class="value">{{ loanAmount() | number:'1.2-2':'de-DE' }} €</span>
  </div>

  @if (mortgageResult(); as m) {
    @if (m.monthlyPayment > 0) {
      <div class="results">
        <div class="result-item">
          <span class="label">Monatliche Rate</span>
          <span class="value big">{{ m.monthlyPayment | number:'1.2-2':'de-DE' }} €</span>
        </div>
        <div class="result-item">
          <span class="label">Zinsen in {{ fixedPeriodYears() }} Jahren</span>
          <span class="value">{{ m.totalInterest | number:'1.2-2':'de-DE' }} €</span>
        </div>
        @if (m.totalSpecialRepayment > 0) {
          <div class="result-item">
            <span class="label">Sondertilgungen gesamt</span>
            <span class="value">{{ m.totalSpecialRepayment | number:'1.2-2':'de-DE' }} €</span>
          </div>
        }
        <div class="result-item">
          <span class="label">Restschuld nach {{ fixedPeriodYears() }} Jahren</span>
          <span class="value">{{ m.remainingDebt | number:'1.2-2':'de-DE' }} €</span>
        </div>
        @if (m.remainingDebt > 0 && m.totalTermMonths > 0) {
          <div class="result-item">
            <span class="label">Gesamtlaufzeit bei gleichen Konditionen</span>
            <span class="value">{{ (m.totalTermMonths - m.totalTermMonths % 12) / 12 }} Jahre {{ m.totalTermMonths % 12 }} Monate</span>
          </div>
        }

        @if (mortgageResultWithout(); as mw) {
          <div class="comparison">
            <span class="comparison-label">Ohne Sondertilgung wäre die Restschuld</span>
            <span class="comparison-value">{{ mw.remainingDebt | number:'1.2-2':'de-DE' }} €</span>
            <span class="comparison-diff">
              ({{ mw.remainingDebt - m.remainingDebt | number:'1.0-0':'de-DE' }} € mehr)
            </span>
          </div>
        }
      </div>

      @if (m.schedule.length > 0) {
        <app-tilgungsplan [schedule]="m.schedule" [hasSpecialRepayment]="m.totalSpecialRepayment > 0" />
      }
    }
  }
</div>
